## المشاكل المكتشفة

* وحدة مفقودة: `index.js:6` يستورد `./utils/contract` لكنها غير موجودة في المشروع.

* فحص الاتصال غير صحيح: `index.js:29` يستدعي `web3.eth.net.isListening()` دون `await` داخل دالة `async`.

* خطأ مرجعي في المطالبة بالمكافآت: استخدام متغير غير معرّف `currentPoints` داخل المعالج `POST /claim-rewards` عند الأسطر `index.js:274`, `index.js:283`, `index.js:286`, `index.js:299-303`.

* تنسيق الرصيد يفترض دائمًا 18 منزلة: `fromWei(balance,'ether')` في `index.js:119` و`index.js:144` يتجاهل القيمة الحقيقية من `getTokenDecimals()`.

* ملف النشر غير صالح: `render.yaml` يحتوي كود JavaScript بدءًا من السطر 13؛ يجب أن يكون YAML فقط.

* اعتماديات التطوير: سكربت `dev` يستخدم `nodemon` وهو غير مثبت.

## التغييرات المقترحة

* إنشاء ملف `utils/contract.js`:

  * تهيئة `web3` باستخدام `process.env.RPC_URL` (أو قيمة افتراضية من Render مثل `https://testnet-rpc.monad.xyz`).

  * تعريف ABI مبسّط لـ ERC-20 (`name`, `symbol`, `decimals`, `totalSupply`, `balanceOf`).

  * قراءة عنوان العقد من `process.env.BTM_TOKEN_CONTRACT_ADDRESS`؛ توفير قيمة افتراضية مؤقتة إذا كانت غير متاحة.

  * تصدير دوال: `getTokenName`, `getTokenSymbol`, `getTokenDecimals`, `getTokenTotalSupply`, `getTokenBalance`، بالإضافة إلى تصدير `web3` ومرجع العقد.

  * التعامل مع حالات فشل الاتصال بإرجاع رسائل خطأ واضحة دون إسقاط الخادم.

* تعديل `index.js`:

  * إضافة `await` إلى `web3.eth.net.isListening()` داخل `testConnection` في `index.js:29`.

  * إصلاح معالج `POST /claim-rewards` ليقرأ النقاط من `playerPointsDB[playerAddress] || 0` بدل المتغير غير المعرّف، والتحقق من وجود نقاط قبل التحويل، ثم إعادة ضبط نقاط اللاعب بعد نجاح المطالبة.

  * استخدام `decimals` الحقيقية لتنسيق الرصيد بدلًا من افتراض 18؛ حساب التنسيق وفق `decimals` في مسارات `/balance` و`/balance/:address`.

  * توحيد CORS بإبقاء `app.use(cors())` أو تقييده عبر `origin` واحد حسب الحاجة؛ إزالة أي إعدادات متضاربة.

  * تنظيف الاستيرادات غير المستعملة (إن وُجدت) مع الحفاظ على الاتساق.

* تنظيف `render.yaml`:

  * إزالة كود JavaScript بالكامل من السطر 13 إلى نهاية الملف؛ إبقاء تعريف الخدمة فقط:

    * `type`, `name`, `env`, `buildCommand`, `startCommand`, `envVars` (`RPC_URL`, `PORT`).

* ضبط المتغيرات البيئية:

  * إضافة ودعم: `RPC_URL`, `BTM_TOKEN_CONTRACT_ADDRESS`, `BTM_TOKEN_DECIMALS` في بيئة التشغيل (دون تضمين أسرار في المستودع).

  * إبقاء المفاتيح الخاصة خارج الكود؛ أي تحويلات حقيقية على السلسلة تُدار عبر متغيرات بيئة آمنة فقط.

* اعتماديات التطوير:

  * تثبيت `nodemon` كاعتمادية تطويرية إذا سيُستخدم `npm run dev`.

## خطوات التحقق بعد التطبيق

* تشغيل الخادم محليًا عبر `npm start` ثم التحقق من:

  * `GET /health` يعيد `{ status: 'ok' }`.

  * `GET /token-info` يعرض الاسم/الرمز/العُشرية/الإجمالي بنجاح.

  * `GET /balance/<address>` يعيد رصيدًا منسّقًا يعتمد `decimals`.

  * `POST /add-points` ثم `GET /get-points/:address` يُظهران التراكم الصحيح للنقاط.

  * `POST /claim-rewards` يعمل دون خطأ مرجعي، ويعيد نتيجة نجاح/فشل مناسبة ويُعيد ضبط نقاط اللاعب.

  * الوصول لمسارات غير معرّفة يعيد 404 بصيغة `{ error, path }`.

## اعتبارات الأمن والنشر

* عدم تضمين أي مفاتيح خاصة أو أسرار داخل المستودع.

* تقييد CORS إلى نطاق الواجهة عند النشر إن أمكن.

* إبقاء `render.yaml` صالحًا وموحّدًا مع متغيرات البيئة.

## التسليم

* تنفيذ جميع التعديلات المذكورة، وتقديم تغييرات الملفات على شكل حزمة واحدة سهلة المراجعة، مع الحفاظ على أسلوب المشروع الحالي.

